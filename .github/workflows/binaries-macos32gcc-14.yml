name: Binaries MacOS-14 (macos32gcc)

on:
  workflow_dispatch:
    branches: [ master ]

permissions:
  contents: read
env:
   VERSION: "091224b"
   OS: "macos-14"
jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies on MacOS and compile and produce BFS exes and standalone ME application 
        run: |
           echo `uname -a`
           uname -r
           brew install xquartz
           brew install make
           brew install coreutils
           export PATH=/opt/homebrew/opt/make/libexec/gnubin:$PATH
           export PATH=/opt/homebrew/opt/coreutils/libexec/gnubin:$PATH
           export VRS=`grep -E 'meYEAR|meMONTH|meDAY' src/evers.h | head -n 3 | awk '{ print $3 }' | paste -sd '-' | sed 's/[-"]//g'`
           echo "VRS=$VRS" >> $GITHUB_ENV

      - name: make bfs binary
        run:  make -f macos32gcc.gmk bfs/bin CC=gcc-14

      - name: make mec binary
        run:  make -f macos32gcc.gmk mec CC=gcc-14

      - name: make mew binary
        run:  make -f macos32gcc.gmk mew CC=gcc-14
        
      - name: make mecw binary
        run:  make -f macos32gcc.gmk mecw CC=gcc-14
        
      - name: make mecb binary 
        run:  make -f macos32gcc.gmk mecb VERSION=${VRS}
        
      - name: make mewb binary 
        run:  make -f macos32gcc.gmk mewb VERSION=${VRS} 
        
      - name: make mecwb binary 
        run: make -f macos32gcc.gmk mecwb VERSION=${VRS} 
        

      - name: Make release
        run: |
          mkdir MicroEmacs09-${VRS}-${OS}
          mkdir MicroEmacs09-${VRS}-${OS}/bin
          cp bfs/bfs MicroEmacs09-${VRS}-${OS}/bin/
          cp src/.macos32gcc-release-mecw/mecw MicroEmacs09-${VRS}-${OS}/bin/
          cp src/.macos32gcc-release-mec/mec  MicroEmacs09-${VRS}-${OS}/bin/
          cp src/.macos32gcc-release-mew/mew  MicroEmacs09-${VRS}-${OS}/bin/          
          cp me*.bin MicroEmacs09-${VRS}-${OS}/bin/
          cp license.txt MicroEmacs09-${VRS}-${OS}/
          cp COPYING MicroEmacs09-${VRS}-${OS}/
          cp README-standalone.md MicroEmacs09-${VRS}-${OS}/
          cd jasspa 
          zip macros.zip macros/*
          cd ..
          cp jasspa/macros.zip MicroEmacs09-${VRS}-${OS}/

      - name: Make mecb release
        run: |
          mkdir MicroEmacs09-${VRS}-${OS}-mecb
          mkdir MicroEmacs09-${VRS}-${OS}-mecb/bin
          cp bfs/bfs MicroEmacs09-${VRS}-${OS}-mecb/bin/
          cp mecb*.bin MicroEmacs09-${VRS}-${OS}-mecb/bin/
          cp license.txt MicroEmacs09-${VRS}-${OS}-mecb/
          cp COPYING MicroEmacs09-${VRS}-${OS}-mecb/
          cp README-standalone.md MicroEmacs09-${VRS}-${OS}-mecb/

      - name: Make mewb release
        run: |
          mkdir MicroEmacs09-${VRS}-${OS}-mewb
          mkdir MicroEmacs09-${VRS}-${OS}-mewb/bin
          cp bfs/bfs MicroEmacs09-${VRS}-${OS}-mewb/bin/
          cp mewb*.bin MicroEmacs09-${VRS}-${OS}-mewb/bin/
          cp license.txt MicroEmacs09-${VRS}-${OS}-mewb/
          cp COPYING MicroEmacs09-${VRS}-${OS}-mewb/
          cp README-standalone.md MicroEmacs09-${VRS}-${OS}-mewb/

      - name: Make mecwb release
        run: |
          mkdir MicroEmacs09-${VRS}-${OS}-mecwb
          mkdir MicroEmacs09-${VRS}-${OS}-mecwb/bin
          cp bfs/bfs MicroEmacs09-${VRS}-${OS}-mecwb/bin/
          cp mecwb*.bin MicroEmacs09-${VRS}-${OS}-mecwb/bin/
          cp license.txt MicroEmacs09-${VRS}-${OS}-mecwb/
          cp COPYING MicroEmacs09-${VRS}-${OS}-mecwb/
          cp README-standalone.md MicroEmacs09-${VRS}-${OS}-mewb/

      - name: Upload MacOS 14 Release files
        uses: actions/upload-artifact@v4
        with: 
          name: MicroEmacs09-${{ env.VRS }}-${{ env.OS }}
          path: MicroEmacs09-${{ env.VRS }}-${{ env.OS }}
    
      - name: Upload MacOS 14 mecb Release files
        uses: actions/upload-artifact@v4
        with: 
          name: MicroEmacs09-${{ env.VRS }}-${{ env.OS }}-mecb
          path: MicroEmacs09-${{ env.VRS }}-${{ env.OS }}-mecb

      - name: Upload MacOS 14 mewb Release files
        uses: actions/upload-artifact@v4
        with: 
          name: MicroEmacs09-${{ env.VRS }}-${{ env.OS }}-mewb
          path: MicroEmacs09-${{ env.VRS }}-${{ env.OS }}-mewb

      - name: Upload MacOS 14 mecwb Release files
        uses: actions/upload-artifact@v4
        with: 
          name: MicroEmacs09-${{ env.VRS }}-${{ env.OS }}-mecwb
          path: MicroEmacs09-${{ env.VRS }}-${{ env.OS }}-mecwb
